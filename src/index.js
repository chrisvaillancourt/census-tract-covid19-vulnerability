require([
  'esri/Map',
  'esri/views/MapView',
  'esri/layers/VectorTileLayer',
  'esri/Basemap',
  'esri/layers/FeatureLayer',
  'esri/widgets/Legend',
  'esri/widgets/Home',
  'esri/widgets/Expand',
], function (
  Map,
  MapView,
  VectorTileLayer,
  Basemap,
  FeatureLayer,
  Legend,
  Home,
  Expand
) {
  const vectorBaseLayer = new VectorTileLayer({
    url: `https://www.arcgis.com/sharing/rest/content/items/2afe5b807fa74006be6363fd243ffb30/resources/styles/root.json`,
  });
  const vectorBaseReference = new VectorTileLayer({
    url: `https://www.arcgis.com/sharing/rest/content/items/ba52238d338745b1a355407ec9df6768/resources/styles/root.json`,
    opacity: 0.7,
  });
  const vectorDetailLayer = new VectorTileLayer({
    url: `https://www.arcgis.com/sharing/rest/content/items/97fa1365da1e43eabb90d0364326bc2d/resources/styles/root.json`,
    opacity: 0.35,
  });

  const basemap = new Basemap({
    baseLayers: [vectorBaseLayer, vectorDetailLayer],
    referenceLayers: [vectorBaseReference],
  });

  const covidRenderer = {
    type: 'simple',
    symbol: {
      type: 'simple-fill',
      outline: {
        color: [145, 145, 145, 0.15],
        width: '0.5px',
      },
    },
    label: 'Census Tract',
    visualVariables: [
      {
        type: 'color',
        field: 'Covid_19_Vulnerability_Index',
        stops: [
          {
            value: '24',
            color: '#411b6d',
            label: '24',
          },
          {
            value: '43',
            color: '#fffee6',
            label: '43',
          },
          {
            value: '62',
            color: '#990b0b',
            label: '62',
          },
        ],
      },
    ],
  };

  const infrastructureRenderer = {
    type: 'simple',
    symbol: {
      type: 'simple-fill',
      outline: {
        color: [145, 145, 145, 0.15],
        width: '0.5px',
      },
    },
    label: 'Census Tract',
    visualVariables: [
      {
        type: 'color',
        field: 'Health_Infrastructure',
        stops: [
          {
            value: '30',
            color: '#411b6d',
            label: '30',
          },
          {
            value: '50',
            color: '#fffee6',
            label: '50',
          },
          {
            value: '71',
            color: '#990b0b',
            label: '71',
          },
        ],
      },
    ],
  };

  const demographicsRenderer = {
    type: 'simple',
    symbol: {
      type: 'simple-fill',
      outline: {
        color: [145, 145, 145, 0.15],
        width: '0.5px',
      },
    },
    label: 'Census Tract',
    visualVariables: [
      {
        type: 'color',
        field: 'Population_Demographics',
        stops: [
          {
            value: '12',
            color: '#411b6d',
            label: '12',
          },
          {
            value: '30.5',
            color: '#fffee6',
            label: '30.5',
          },
          {
            value: '48',
            color: '#990b0b',
            label: '48',
          },
        ],
      },
    ],
  };

  const issuesRenderer = {
    type: 'simple',
    symbol: {
      type: 'simple-fill',
      outline: {
        color: [145, 145, 145, 0.15],
        width: '0.5px',
      },
    },
    label: 'Census Tract',
    visualVariables: [
      {
        type: 'color',
        field: 'Underlying_Health_Issues',
        stops: [
          {
            value: '22',
            color: '#411b6d',
            label: '22',
          },
          {
            value: '41.5',
            color: '#fffee6',
            label: '41.5',
          },
          {
            value: '61',
            color: '#990b0b',
            label: '61',
          },
        ],
      },
    ],
  };

  const covidPopupTemplate = {
    title: 'Tract {FIPS_text}',
    content: `
      <p>The COVID-19 vulnerability index for this area is <strong>{Covid_19_Vulnerability_Index}</strong>.</p>
      <p>Indicators impacting this value include:</p>
      <ul>
        <li>Population Demographics: <strong>{Population_Demographics}</strong></li>
        <li>Underlying Health Issues: <strong>{Underlying_Health_Issues}</strong></li>
        <li>Health infrastructure: <strong>{Health_Infrastructure}</strong></li>
      </ul>
      `,
    fieldInfos: [
      {
        fieldName: 'Covid_19_Vulnerability_Index',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Population_Demographics',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Underlying_Health_Issues',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Health_Infrastructure',
        format: {
          places: 0,
        },
      },
    ],
  };
  const infrastructurePopupTemplate = {
    title: 'Tract {FIPS_text}',
    content: `
      <p>The health infrastructure vulnerability index for this area is <strong>{Health_Infrastructure}</strong>.</p>
      <p>Indicators impacting this value include:</p>
      <ul>
        <li>Pop. 18-64 with no health insurance: <strong>{Percentage_of_pop__18_64_with_n}%</strong></li>
        <li>Hospital beds per 1,000 pop. within 25km radius: <strong>{Number_of_hospital_beds_per_1_0}</strong></li>
        <li>Urgent care facilities per 1,000 pop. within 25km radius: <strong>{Number_of_urgent_care_facilitie}</strong></li>
        <li>Ratio of the population to primary care physicians: <strong>{Ratio_of_the_population_to_prim}</strong></li>
      </ul>
      `,
    fieldInfos: [
      {
        fieldName: 'Health_Infrastructure',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Percentage_of_pop__18_64_with_n',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Number_of_hospital_beds_per_1_0',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Number_of_urgent_care_facilitie',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Ratio_of_the_population_to_prim',
        format: {
          places: 0,
        },
      },
    ],
  };

  const demographicsPopupTemplate = {
    title: 'Tract {FIPS_text}',
    content: `
      <p>The population demographics vulnerability index for this area is <strong>{Population_Demographics}</strong>.</p>
      <p>Indicators impacting this value include:</p>
      <ul>
        <li>Population aged 80+: <strong>{Population_aged_80___percentage}%</strong></li>
        <li>Population aged 70-79: <strong>{Population_aged_70_79__percenta}%</strong></li>
        <li>Population aged 60-69: <strong>{pop_aged_60_69_p}%</strong></li>
        <li>Population density per 10,000: <strong>{Population_density_per_10_000}</strong></li>
        <li>Nursing home population per 1,000: <strong>{Nursing_home_population_per_1_0}</strong></li>
        <li>Prison population per 1,000: <strong>{Prison_population_per_1_000}</strong></li>
      </ul>
      `,
    fieldInfos: [
      {
        fieldName: 'Population_Demographics',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Population_aged_80___percentage',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Population_aged_70_79__percenta',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'pop_aged_60_69_p',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Population_density_per_10_000',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Nursing_home_population_per_1_0',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Prison_population_per_1_000',
        format: {
          places: 0,
        },
      },
    ],
  };

  const issuesPopupTemplate = {
    title: 'Tract {FIPS_text}',
    content: `<p>The underlying health issues vulnerability index for this area is <strong>{Underlying_Health_Issues}</strong>.</p>
      <p>Indicators impacting this value include:</p>
      <ul>
        <li>Adult high blood pressure prevalence: <strong>{High_blood_pressure_prevalence_}</strong></li>
        <li>Adult cancer prevalence: <strong>{Cancer_prevalence_in_adults_18_}</strong></li>
        <li>Adult asthma prevalence: <strong>{Asthma_prevalence_among_adults_}</strong></li>
        <li>Adult coronary heart disease prevalence: <strong>{Coronary_heart_disease_prevalen}</strong></li>
        <li>Adult COPD prevalence: <strong>{COPD_prevalence_among_adults_18}</strong></li>
        <li>Adult active smoking: <strong>{Active_smoking_in_adults_18_}</strong></li>
        <li>Adult diabetes prevalence: <strong>{Diabetes_prevalence_in_adults_1}</strong></li>
      </ul>`,
    fieldInfos: [
      {
        fieldName: 'Underlying_Health_Issues',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'High_blood_pressure_prevalence_',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Cancer_prevalence_in_adults_18_',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Asthma_prevalence_among_adults_',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Coronary_heart_disease_prevalen',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'COPD_prevalence_among_adults_18',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Active_smoking_in_adults_18_',
        format: {
          places: 0,
        },
      },
      {
        fieldName: 'Diabetes_prevalence_in_adults_1',
        format: {
          places: 0,
        },
      },
    ],
  };

  const featureLayer = new FeatureLayer({
    url:
      'https://services7.arcgis.com/Fnhc04BJL93uqCjd/ArcGIS/rest/services/COVID19_Vulnerability/FeatureServer/0',
    renderer: covidRenderer,
    popupEnabled: true,
    popupTemplate: covidPopupTemplate,
    title: 'Census Tract',
  });
  const map = new Map({
    basemap,
    layers: [featureLayer],
  });
  const view = new MapView({
    container: 'viewDiv',
    map,
    center: [-98.5795, 39.8282],
    zoom: 3,
  });
  view.when(() => {
    // view ready
    const homeWidget = new Home({
      view,
    });
    const legend = new Legend({
      view,
      container: document.createElement('div'),
      layerInfos: [
        {
          layer: featureLayer,
          title: 'legend',
        },
      ],
    });

    const expandLegend = new Expand({
      view,
      content: legend,
      expanded: true,
      expandIconClass: 'esri-icon-key',
    });
    view.ui.add([homeWidget, expandLegend], 'top-left');
  });

  function changeSelection(e) {
    if (e.target.name != 'options') return;
    const {
      target: { value }, // value comes from HTML value
    } = e;
    switch (value) {
      case 'covid':
        featureLayer.renderer = covidRenderer;
        featureLayer.popupTemplate = covidPopupTemplate;
        break;
      case 'infrastructure':
        featureLayer.renderer = infrastructureRenderer;
        featureLayer.popupTemplate = infrastructurePopupTemplate;

        break;
      case 'demographics':
        featureLayer.renderer = demographicsRenderer;
        featureLayer.popupTemplate = demographicsPopupTemplate;

        break;
      case 'issues':
        featureLayer.renderer = issuesRenderer;
        featureLayer.popupTemplate = issuesPopupTemplate;
        break;
      default:
        featureLayer.renderer = covidRenderer;
        featureLayer.popupTemplate = covidPopupTemplate;
    }
  }
  document.addEventListener('change', changeSelection, false);
  const inputs = document.querySelectorAll('input');
  //todo make input dynamically generated
  inputs.forEach((input) =>
    input.value == 'covid'
      ? input.setAttribute('checked', '')
      : input.removeAttribute('checked')
  ); // reset input on reload
});
